# HTTP redirige a HTTPS
server {
    listen 80;
    server_name api.seguro.local;

    return 301 https://$host$request_uri;
}

# HTTPS + HTTP/2 + rate limiting
server {
    listen 443 ssl http2;
    server_name api.seguro.local;

    root /var/www/act3_2/api;
    index index.html;

    ssl_certificate     /etc/nginx/certs/api.seguro.local.crt;
    ssl_certificate_key /etc/nginx/certs/api.seguro.local.key;

    include /etc/nginx/snippets/ssl-params.conf;

    # Sin autenticación, solo rate limiting global
    limit_req zone=api burst=20 nodelay;

    # Headers API
    add_header X-API-Version "1.0";
    add_header Access-Control-Allow-Origin "*" always;

    # Documentación web normal
    location = / {
        try_files $uri $uri/ =404;
    }

    location = /v1/docs.html {
        try_files $uri $uri/ =404;
    }

    # Endpoint /v1/status JSON
    location = /v1/status {
        default_type application/json;
        add_header Content-Type "application/json";
        return 200 '{"status":"online","version":"1.0","timestamp":"2025-01-15T10:30:00Z"}';
    }

    # Endpoint /v1/users JSON
    location = /v1/users {
        default_type application/json;
        add_header Content-Type "application/json";
        return 200 '{"users":[{"id":1,"name":"Alice"},{"id":2,"name":"Bob"}]}';
    }

    # Endpoint /health JSON
    location = /health {
        default_type application/json;
        add_header Content-Type "application/json";
        return 200 '{"status":"healthy"}';
    }
}
